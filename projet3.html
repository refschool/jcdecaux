<!DOCTYPE html>
<html>

<head>
	<title>Projet3</title>
	<script src="https://code.jquery.com/jquery-3.5.1.js"
	integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
	integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
	<link rel="stylesheet" href="style_projet3.css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
	integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
	crossorigin="anonymous" />
	<!-- Make sure you put this AFTER Leaflet's CSS -->
	<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
	integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
	crossorigin="anonymous"></script>
	<meta charset="utf-8">
</head>

<body>
<div id="page">
	<div id="entete"><h1>LOCATION DE VELO</h1></div>
	<div id="conteneur">
		<img src="velib1.jpg">
		<p id="explicationText">Ce Site permet de réserver un vélo</p>
		<div id="divImgVelo1" class="rotation1"><img id="imgVelo1" src="velovelo1.png"></div>
		<div id="divImgVelo2" class="rotation2"><img id="imgVelo2" src="velovelo2.png"></div>
	</div>
	<div id="lesbtn">
		<button id="back">Précédent</button>
		<button id="next">Suivant</button>
		<button id="boutondual">Play</button>
	</div>
	<div class="container">
		<div class="row">
			<div class="col-6">
				<div id="mapid"></div>
			</div>
			<div class="col-6">
				<div id="cont-form">
					<form id="formulaire">
						Nom de la station:<br>
						<label id="label1"></label><br>
						adresse:<br>
						<label id="label2"></label><br>
						Nombre de vélos disponibles:<br>
						<label id="label3"></label><br>
						<br>
						<strong> Nom </strong><br>
						<input type="text" name="Nom" id="nom"> <br>
						<strong> Prenom </strong> <br>
						<input type="text" name="Prenom" id="prenom">
						<button id="boutonReserver">Réserver</button>
					</form>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<div id="canvasDiv">
					<canvas id="can" width="500" height="200">NORMALEMENT le canvas s'affiche ici</canvas>

					<div id="lesbtnCanvas">
						<button id="clr" type="button" width=100>Effacer</button>
						<button id="confirmer" type="submit" class="boutton_confirm" width=100>Confirmer</button>
					</div>
				</div>


			</div>
		</div>

	</div>

	<div class="row black espace">
		<div class="col black">
			<div id="rebours"></div>
		</div>
	</div>
</div>
</body>
<script src="projet3.js"></script>
<script>

	var mymap = L.map('mapid').setView([45.7577, 4.8374], 15);
	L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}{r}.png?{foo}', { foo: 'bar', attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>' }).addTo(mymap);

	checkAll();

	$(function () {
		let handler;
		let tempsInit = 2 * 60;


	if (localStorage.getItem("nom_personne_form") != '' && localStorage.getItem("prenom_personne_form") != '') {
		let nomPersonneForm = localStorage.getItem("nom_personne_form");
		let prenomPersonneForm = localStorage.getItem("prenom_personne_form");
		$('#nom').val(nomPersonneForm);
		$('#prenom').val(prenomPersonneForm);
	}

	class Diapo
	{
		constructor()
		{
			this.tableauImage  = ['velib1.jpg', 'velib2.jpg', 'velib3.jpg', 'velib4.jpg', 'velib5.jpg'];
			this.tableauTexte =  ['Ce Site permet de réserver un vélo', 'Pour cela vous avez à votre disposition une carte avec l\'emplacement des differents sites', 'à droite de la carte vous pouvez en cliquant sur les marqueur avoir les info de la station', 'vous avez aussi la possibilité de reserver un velo en fournissant votre nom et votre prénom', 'enfin vous n\'aurez plus qu\'à signer'];
			this.i = 0;
			this.j = 0;
			this.surPause = true;
			this.handle = null;
		}

		start() 
		{
			if (this.surPause==false) 
			{
				clearInterval(this.handle);
				this.surPause = true;
				document.getElementById('boutondual').innerHTML = "Play";
				return;
			}
			else 
			{
				let handle = setInterval(this.suiv.bind(this), 1000);
				this.surPause = false;
				document.getElementById('boutondual').innerHTML = "Pause";
				//$('#boutondual').text('Pause');// enlever tout le jquery mettre du javascript pour le diapo !!!
				return handle;
			}
		}

		stop() 
		{
			clearInterval(this.handle)
			document.getElementById('boutondual').innerHTML = "Play";
			//$('#boutondual').text('Play');
		}

		suiv() 
		{
			this.i++;
			this.j++;

			if (this.i == 5 || this.j == 5) {
				this.i = 0;
				this.j = 0;
			}


			document.getElementById('conteneur').innerHTML = '<img src="' + this.tableauImage[this.i]+ '">' + '<p id="explicationText">"' + this.tableauTexte[this.j]+ '"</p>'+'<div id="divImgVelo1" class="rotation1"><img id="imgVelo1" src="velovelo1.png"></div>'+
		'<div id="divImgVelo2" class="rotation2"><img id="imgVelo2" src="velovelo2.png"></div>';

			/*$('#conteneur').html('<img src="' + this.tableauImage[this.i]+ '">' + '<p id="explicationText">"' + this.tableauTexte[this.j]+ '"</p>'+'<div id="divImgVelo1" class="rotation1"><img id="imgVelo1" src="velovelo1.png"></div>'+
		'<div id="divImgVelo2" class="rotation2"><img id="imgVelo2" src="velovelo2.png"></div>');//ici aussi mettre ne javascript */


		};

		prec() 
		{
			this.i--;
			this.j--;
			if (this.i < 0 || this.j < 0) {
				this.i = 4;
				this.j = 4;
			}

			document.getElementById('conteneur').innerHTML = '<img src="' + this.tableauImage[this.i] + '">' + '<p id="explicationText">"' + this.tableauTexte[this.j] + '"</p>'+'<div id="divImgVelo1" class="rotation1"><img id="imgVelo1" src="velovelo1.png"></div>'+
		'<div id="divImgVelo2" class="rotation2"><img id="imgVelo2" src="velovelo2.png"></div>';


			/*$('#conteneur').html('<img src="' + this.tableauImage[this.i] + '">' + '<p id="explicationText">"' + this.tableauTexte[this.j] + '"</p>'+'<div id="divImgVelo1" class="rotation1"><img id="imgVelo1" src="velovelo1.png"></div>'+
		'<div id="divImgVelo2" class="rotation2"><img id="imgVelo2" src="velovelo2.png"></div>');//ici aussi*/

		}

	}

	class Reservation //majuscule class passer les parametre nom
	{
		constructor()
		{

		}

		sauvegarderNom(nom,prenom)
		{
			//($('#nom').val() != '') && ($('#prenom').val() != '')
			//(document.getElementById('nom').val != '')&& (document.getElementById('prenom').val !='')
			if ((document.getElementById('nom').val != '') && (document.getElementById('prenom').val !=''))
			{
				localStorage.setItem("nom_personne_form", nom);
				localStorage.setItem("prenom_personne_form", prenom);
			}
		}

	}

	class Compte_a_rebours
	{
		constructor()
		{
			this.recupTemps = function()
			{
				let tempsSauvegarder = localStorage.getItem('tempsRestant');
				if (tempsSauvegarder) 
				{
					tempsInit = tempsSauvegarder;
				}
				else
				{
					clearInterval(handler);
					tempsInit = 2*60;
				}
			}
		}

		demarrer()
		{
			handler = setInterval(function () {
				tempsInit--;
				localStorage.setItem("tempsRestant", tempsInit);
				affiche(localStorage.getItem("tempsRestant"));
			}, 1000);
			return handler;
		}
	}


		// Affiche le temps lisible pour un humain
		function affiche(x) {
			if (x) {
				let chaine = convertToUserFriendly(x);
				//$('#rebours').text
				document.getElementById('rebours').innerHTML = 'Vélo réservé à l\'adresse : '+localStorage.getItem('adresseStation')+ ' par '+localStorage.getItem('prenom_personne_form')+' '+
					localStorage.getItem('nom_personne_form')+' , temps restant: ' + chaine;
			}
		}


		let nouveauDiapo = new Diapo();


		$('#next').on('click', function()
		{
			nouveauDiapo.suiv();
		});
		$('#back').on('click', function()
		{
			nouveauDiapo.prec();
		});


		$('#boutondual').on('click', function()
		{
			nouveauDiapo.handle = nouveauDiapo.start();

		});

		document.onkeydown = function (e) {
			switch (e.keyCode) {
				case 37:
				nouveauDiapo.prec();
				break;
				case 39:
				nouveauDiapo.suiv();
				break;
			}
		};

			var isRefresh = false;

			$(document).on("keydown", function(e) {
				if (e.which === 116)
				{
					isRefresh = true;
				}
			});

			window.onbeforeunload = function() {
				if (isRefresh==false)
				{
					localStorage.setItem('tempsRestant', 0);
					return ;
				}

			};

			$('#confirmer').on('click', function () {
				clearInterval(handler);
		let UneReservation = new Reservation();
		UneReservation.sauvegarderNom(($('#nom').val()),($('#prenom').val()));
		console.log($('#nom').val());
		console.log($('#prenom').val());
		sauvegarderadresseStation();
		//clearInterval();
		localStorage.setItem('tempsRestant', 2*60);
		//demarrerCompteur();
		let NouveauCompteur = new Compte_a_rebours();
		NouveauCompteur.recupTemps();
		NouveauCompteur.demarrer();
	});


	function init() {

		console.log('je suis dans init()');

		var imageSrc = 'img/image.jpg'
		backgroundImage = new Image();
		backgroundImage.src = imageSrc;


		canvas = document.getElementById('can');
		finalImg = document.getElementById('finalImg');
		canvasimg = document.getElementById('canvasimg');
		canvas.style.backgroundImage = "url('" + imageSrc + "')";
		canvas.addEventListener("mousemove", handleMouseEvent);
		canvas.addEventListener("mousedown", handleMouseEvent);
		canvas.addEventListener("mouseup", handleMouseEvent);
		canvas.addEventListener("mouseout", handleMouseEvent);

		$('#clr').on('click', erase);
		$('#boutonReserver').on('click', afficheCanvas); //jquery ou javascript ?
		//récupération temps au rechargement
		if (localStorage.getItem("tempsRestant") != null) {
			tempsInit = localStorage.getItem("tempsRestant")
			//demarrerCompteur()*/
			let NouveauCompteur = new Compte_a_rebours();
			NouveauCompteur.demarrer();
		}

	}

	//https://stackoverflow.com/questions/2368784/draw-on-html5-canvas-using-a-mouse


	var canvas, canvasimg, backgroundImage, finalImg;
	var mouseClicked = false;
	var prevX = 0;
	var currX = 0;
	var prevY = 0;
	var currY = 0;
	var fillStyle = "black";
	var globalCompositeOperation = "source-over";
	var lineWidth = 2; // object json


	function draw(dot) {
		var ctx = canvas.getContext("2d");
		ctx.beginPath();
		ctx.globalCompositeOperation = globalCompositeOperation;
		if (dot) {
			ctx.fillStyle = fillStyle;
			ctx.fillRect(currX, currY, 2, 2);
		} else {
			ctx.beginPath();
			ctx.moveTo(prevX, prevY);
			ctx.lineTo(currX, currY);
			ctx.strokeStyle = fillStyle;
			ctx.lineWidth = lineWidth;
			ctx.stroke();
		}
		ctx.closePath();
	}

	function erase() {
		var ctx = canvas.getContext("2d");
		ctx.clearRect(0, 0, canvas.width, canvas.height);

	}

	function handleMouseEvent(e) {
		if (e.type === 'mousedown') {
			prevX = currX;
			prevY = currY;
			currX = e.offsetX;
			currY = e.offsetY;
			mouseClicked = true;
			draw(true);
		}
		if (e.type === 'mouseup' || e.type === "mouseout") {
			mouseClicked = false;
		}
		if (e.type === 'mousemove') {
			if (mouseClicked) {
				prevX = currX;
				prevY = currY;
				currX = e.offsetX;
				currY = e.offsetY;
				draw();
			}
		}
	}

	init();
})

</script>
<!--<script src="projet3.js"></script>-->

</html>